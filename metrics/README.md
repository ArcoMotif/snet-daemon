# Daemon Metrics & Monitoring Services

```snet-daemon``` sends heartbeat upon the request from a monitoring service or any other component.
Apart from heartbeat, it will expose few custom metrics as mentioned below metrics section.
<br/>
The critical daemon updates, warning, or errors can be reported to a pre-configured email using a default 
notification service offered by SingularityNet. Its just an optional service. Service providers are free to choose thier own endpoints/web hooks for sending alerts.

### Registration
Daemon Registration is required for the metrics services to uniquely identufy every daemon and store the 
metrics accordingly. To register with metrics service, every daemon must have a Unique Identity i.e. DaemonID.
Daemon ID is a SHA256 hash value generated by using - Org name, Service Name, and Daemon Endpoint.

```
daemonID = SHA256(config.GetString(config.OrganizationName) + config.GetString(config.ServiceName) + config.GetString(config.DaemonEndPoint)

```
Post beta, this ID will be used to enable Token based authentication for accessing metrics services.

### Heartbeat
Heartbeat indicates the state of the Daemon and the service associated with it. The heartbeat message from the daemon 
wraps the heartbeat of the service and sends it when requested. Heartbeat is always pull based, i.e. The monitoring service 
will have to call the heartbeat service to get the Daemon state. <br/>

When the monitoring services calls daemon heartbeat, the daemon internally makes a call to service heartbeat endpoint.
Upon receiving the service heartbeat, Daemon wraps it in the final heartbeat and sends it to the calling service.

For service heartbeat, implementation followed the standard health checking protocol as defined in [gRPC Health Checking Protocol](https://github.com/grpc/grpc/blob/master/doc/health-checking.md).
The service must use the same proto and implement the heartbeat functionality. 

```
Heartbeats will be enabled by default and they cant be disabled.
```

##### Configuration  
   * **service_heartbeat_type** (mandatory. ```http|grpc```) - though All services must be using grpc, for the 
   simplicity of heartbeat implementation, both http and gRPC based heartbeat end points are supported. 
   
   * **heartbeat_svc_end_point** (mandatory ```must be a valid http|https|grpc url```) - It is service heartbeat endpoint. 
   Based on the service heart beat type, if the type is http, then heartbeat service endpoint must be a HTTP endpoint, 
   similarly, if the type is gRPC, then the heartbeat service must follow the health protocol as mentioned above and the 
   gRPC endpoint has to be configured here.

##### Service endpoints 

Heartbeat service is exposed from Daemon endpoint itself, but with with different route <b>```{daemon_endpoint}/heartbeat```</b>
It is pull based service i.e. the monitoring service must call this endpoint to get the heartbeat.

GET http://127.0.0.1:8080/heartbeat

Sample heartbeat from the daemon, which contains the service heartbeat as well
```json
{
  "daemonID": "3a4ebeb75eace1857a9133c7a50bdbb841b35de60f78bc43eafe0d204e523dfe",
  "timestamp": "1544916260",
  "status": "Online",
  "serviceheartbeat": "{\"serviceName\":\"sample1\", \"status\":\"SERVING\"}"
}
```

Daemon must call the services as configured in heartbeat_svc_end_point and the type to get the service heartbeat. 
Sample Heartbeat from Service is

GET http://127.0.0.1:25000/heartbeat
```json
{
  "serviceName":"sample1", 
  "status":"SERVING"
}
```

 
### Metrics  
Each incoming request, outgoing response will be intercepted and the corresponding metrics will be extracted.
The extracted metrics will be reported immediately to the metrics services as configured in the Daemon configuration.
<br/>

<b>Metrics collection is enabled by default</b> in configuration. Service Provider can disable the metrics anytime, if he/she doesn wanted to collect any metrics.
<br/>

The metrics being collected are
   * **No of Requests** - number of requests received by the service endpoint.
   
   * **No of Successful/Failed Requests** - number of requests successfully handled and number fo requesed rejected/failed. Reason for failures could be
   anything like service errors, rate limited requests, etc.
   
   * **Request Size** 
   
   * **Content Types**
   
   * **No of Responses** - number of responses returned by the service endpoint.
   
   * **No of  Successful/Failed Responses** - number of successful/failed responses.
   
   * **Response Size**
   
   * **Response Time**
   

##### Configuration
 * **monitoring_svc_end_point** (mandatory. ```http|https```) - It is the service endpoint to which we will have to 
 post all the captured metrics.

##### Service endpoint
   
### Alerts/Notifications
It is for alerting the user in case of any issues/errors/warning from the daemon/service, and also pass on some
critical information when needed. Alerts depends on an external webhook or service endpoint o relay the messages to
the configured email address. 

##### configuration  
   * **alert_email** (optional unless metrics enabled. ```must be a valid email```) - an email for the 
   alerts when there is an issue/warning/error/information to be sent. 
   
   * **notification_svc_end_point** (optional unless metrics enabled. ```must be a valid webhook/service end point```) - 
   Its service endpoint or a web hook to receive the alerts/notifications and relay it to alert email, which is configured
   the configuration.
   
##### Service endpoint
POST https://qls7hbwj7d.execute-api.us-east-1.amazonaws.com/beta/notify

Sample Payload
```json
{
    "recipient":"abc.comm@gmail.com",
    "message":"From the API",
    "details":"From the API",
    "component":"daemon",
    "component_id":"ad",
    "type":"INFO",
    "level":"10"
}
```
and the Daemon ID will be added to the request header as Access-Token
```gotemplate
req.Header.Set("Access-Token", daemonID)
```
    
### Configuration in JSON format
This is the sample configuration to enable metrics and heartbeat
```json
  {
      "enable_metrics"            : true,
      "monitoring_svc_end_point"  : "http://demo3208027.mockable.io",
      "notification_svc_end_point": "http://demo3208027.mockable.io/notify",
      "alert_email"               : "xyz.abc@myorg.io",
      "service_heartbeat_type"    : "http",
      "heartbeat_svc_end_point"   : "http://demo3208027.mockable.io/heartbeat"  
   }
```
